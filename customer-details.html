<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customers | Khalid & Sons Petroleum</title>
  <link rel="icon" type="image/png" href="assets/logo.jfif">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/styles.css">
</head>

<body data-page="customers">
  <div id="navbar-placeholder"></div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="mb-0"><i class="bi bi-people me-2"></i>Customers Management</h3>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
        <i class="bi bi-person-plus me-2"></i>Add New Customer
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm border-primary">
          <div class="card-body text-center">
            <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
            <h6 class="mt-2 text-muted">Total Customers</h6>
            <h3 id="total-customers">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-danger">
          <div class="card-body text-center">
            <i class="bi bi-cash-stack text-danger" style="font-size: 2rem;"></i>
            <h6 class="mt-2 text-muted">Total Udhaar</h6>
            <h3 id="total-udhaar">Rs. 0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-success">
          <div class="card-body text-center">
            <i class="bi bi-wallet2 text-success" style="font-size: 2rem;"></i>
            <h6 class="mt-2 text-muted">Total Advance</h6>
            <h3 id="total-advance">Rs. 0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-info">
          <div class="card-body text-center">
            <i class="bi bi-building text-info" style="font-size: 2rem;"></i>
            <h6 class="mt-2 text-muted">Companies</h6>
            <h3 id="total-companies">0</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" id="search-customer" class="form-control" placeholder="Search by name or SR No...">
          </div>
          <div class="col-md-4">
            <select id="filter-category" class="form-select">
              <option value="">All Categories</option>
              <option value="Member">Member</option>
              <option value="Company">Company</option>
              <option value="Government">Government</option>
              <option value="VIP">VIP</option>
              <option value="Owner">Owner</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="clearFilters()">
              <i class="bi bi-x-circle me-1"></i>Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customers Table -->
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>SR No.</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Category</th>
                <th>Balance</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customers-table">
              <tr><td colspan="6" class="text-center text-muted py-4">Loading customers...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addCustomerForm" onsubmit="event.preventDefault(); addCustomer();">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add New Customer</h5>
            <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">SR No *</label>
              <input id="new-sr-no" class="form-control" type="number" required>
              <small class="text-muted">Unique serial number for customer</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Name *</label>
              <input id="new-name" class="form-control" type="text" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input id="new-phone" class="form-control" type="tel" placeholder="03XX-XXXXXXX">
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select id="new-category" class="form-select">
                <option value="Member">Member</option>
                <option value="Company">Company</option>
                <option value="Government">Government</option>
                <option value="VIP">VIP</option>
                <option value="Owner">Owner</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Opening Balance</label>
              <input id="new-balance" class="form-control" type="number" step="0.01" value="0">
              <small class="text-muted">Positive = Udhaar (Customer owes), Negative = Advance (We owe)</small>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-check-circle me-1"></i>Add Customer
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="liveToast" class="toast" role="alert">
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Info</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toast-message">...</div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>  
  <script src="js/app.js"></script>
  <script src="js/customers-page.js"></script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Details | Khalid & Sons Petroleum</title>
  <link rel="icon" type="image/png" href="assets/logo.jfif">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/styles.css">
</head>

<body data-page="customers">
  <div id="navbar-placeholder"></div>

  <div class="container py-4">
        // Customer Info Card 
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0" id="customer-title">Customer Details</h5>
          <button class="btn btn-light btn-sm" onclick="window.history.back()">
            <i class="bi bi-arrow-left"></i> Back
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row" id="customer-info-section">
          <div class="col-md-6">
            <p><strong>SR No:</strong> <span id="customer-sr-no">-</span></p>
            <p><strong>Name:</strong> <span id="customer-name">-</span></p>
            <p><strong>Phone:</strong> <span id="customer-phone">-</span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Category:</strong> <span id="customer-category">-</span></p>
            <p><strong>Current Balance:</strong> <span id="customer-balance" class="badge bg-info">Rs. 0</span></p>
          </div>
        </div>
      </div>
    </div>

            //Monthly Summary Cards 
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <i class="bi bi-droplet-fill text-success" style="font-size: 2rem;"></i>
            <h6 class="mt-2">Petrol (This Month)</h6>
            <h4 id="month-petrol">0 L</h4>
            <small class="text-muted" id="month-petrol-amount">Rs. 0</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <i class="bi bi-droplet-fill text-warning" style="font-size: 2rem;"></i>
            <h6 class="mt-2">Diesel (This Month)</h6>
            <h4 id="month-diesel">0 L</h4>
            <small class="text-muted" id="month-diesel-amount">Rs. 0</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <i class="bi bi-droplet-half text-primary" style="font-size: 2rem;"></i>
            <h6 class="mt-2">Mobil (This Month)</h6>
            <h4 id="month-mobil">0 L</h4>
            <small class="text-muted" id="month-mobil-amount">Rs. 0</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center shadow-sm">
          <div class="card-body">
            <i class="bi bi-cash-stack text-danger" style="font-size: 2rem;"></i>
            <h6 class="mt-2">Total (This Month)</h6>
            <h4 id="month-total">Rs. 0</h4>
            <small class="text-muted">Credit - Debit</small>
          </div>
        </div>
      </div>
    </div>

        // Monthly Bill Generator 
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Generate Monthly Bill</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Select Month</label>
            <select id="bill-month" class="form-select">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Select Year</label>
            <select id="bill-year" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" onclick="generateAndPrintBill()">
              <i class="bi bi-printer"></i> Generate & Print Bill
            </button>
          </div>
        </div>
      </div>
    </div>

        // Transaction History
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h6 class="mb-0">Transaction History</h6>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Fuel/Item</th>
                <th>Quantity</th>
                <th>Amount</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="transactions-history">
              <tr><td colspan="6" class="text-center text-muted py-4">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/app.js"></script>
  <script src="js/monthly-ledger.js"></script>

  <script>
    const supabase = window.supabaseClient;
    let currentCustomerId = null;

    function $(id) { return document.getElementById(id); }

    function formatNumber(num) {
      return Number(num || 0).toLocaleString('en-PK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Get customer ID from URL
    function getCustomerIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Load customer details
    async function loadCustomerDetails() {
      const customerId = getCustomerIdFromURL();
      if (!customerId) {
        alert('No customer selected');
        window.location.href = 'customers.html';
        return;
      }

      currentCustomerId = customerId;

      try {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .eq('id', customerId)
          .single();

        if (error) throw error;

        $('customer-title').textContent = `${data.name} - Details`;
        $('customer-sr-no').textContent = data.sr_no;
        $('customer-name').textContent = data.name;
        $('customer-phone').textContent = data.phone || 'N/A';
        $('customer-category').textContent = data.category;
        
        const balanceClass = data.balance > 0 ? 'bg-danger' : data.balance < 0 ? 'bg-success' : 'bg-info';
        const balanceText = data.balance > 0 ? `Udhaar: Rs. ${formatNumber(data.balance)}` :
          data.balance < 0 ? `Advance: Rs. ${formatNumber(Math.abs(data.balance))}` : 'Zero Balance';
        $('customer-balance').className = `badge ${balanceClass}`;
        $('customer-balance').textContent = balanceText;

        await loadMonthlySum();
        await loadTransactionHistory();
      } catch (error) {
        console.error('Error loading customer:', error);
        alert('Error loading customer details');
      }
    }

    // Load current month summary
    async function loadMonthlySum() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      try {
        const ledger = await window.getMonthlyLedger(currentCustomerId, year, month);
        
        $('month-petrol').textContent = formatNumber(ledger.summary.petrol.qty) + ' L';
        $('month-petrol-amount').textContent = 'Rs. ' + formatNumber(ledger.summary.petrol.amount);
        
        $('month-diesel').textContent = formatNumber(ledger.summary.diesel.qty) + ' L';
        $('month-diesel-amount').textContent = 'Rs. ' + formatNumber(ledger.summary.diesel.amount);
        
        $('month-mobil').textContent = formatNumber(ledger.summary.mobilOil.qty) + ' L';
        $('month-mobil-amount').textContent = 'Rs. ' + formatNumber(ledger.summary.mobilOil.amount);
        
        $('month-total').textContent = 'Rs. ' + formatNumber(ledger.total);
      } catch (error) {
        console.error('Error loading monthly summary:', error);
      }
    }

    // Load transaction history
    async function loadTransactionHistory() {
      try {
        const { data, error } = await supabase
          .from('transactions')
          .select(`*, tank:tanks(fuel_type, name)`)
          .eq('customer_id', currentCustomerId)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        const tbody = $('transactions-history');
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No transactions found</td></tr>';
          return;
        }

        let html = '';
        data.forEach(t => {
          const date = new Date(t.created_at).toLocaleDateString('en-PK');
          const typeClass = t.transaction_type === 'Credit' ? 'badge-danger' : 
                           t.transaction_type === 'Debit' ? 'badge-success' : 'badge-warning';
          const fuelType = t.tank?.fuel_type || t.tank?.name || '-';

          html += `
            <tr>
              <td>${date}</td>
              <td><span class="badge ${typeClass}">${t.transaction_type}</span></td>
              <td>${fuelType}</td>
              <td>${t.liters > 0 ? formatNumber(t.liters) + ' L' : '-'}</td>
              <td><strong>Rs. ${formatNumber(t.amount)}</strong></td>
              <td>${t.description || '-'}</td>
            </tr>
          `;
        });

        tbody.innerHTML = html;
      } catch (error) {
        console.error('Error loading transactions:', error);
      }
    }

    // Generate and print bill
    function generateAndPrintBill() {
      const month = parseInt($('bill-month').value);
      const year = parseInt($('bill-year').value);
      window.printMonthlyBill(currentCustomerId, year, month);
    }

    // Initialize year dropdown
    function initYearDropdown() {
      const currentYear = new Date().getFullYear();
      const yearSelect = $('bill-year');
      
      for (let i = currentYear; i >= currentYear - 5; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }

      // Set current month
      const currentMonth = new Date().getMonth() + 1;
      $('bill-month').value = currentMonth;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      initYearDropdown();
      loadCustomerDetails();
    });
  </script>
</body>
</html> -->