<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mobil Oil | Khalid & Sons Petroleum</title>
<link rel="icon" type="image/png" href="assets/logo.jfif">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="assets/styles.css">
<style>
  /* ‚îÄ‚îÄ Product search dropdown ‚îÄ‚îÄ */
  .product-search-wrap { position: relative; }
  .product-dropdown {
    display: none;
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: #fff;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 260px;
    overflow-y: auto;
    z-index: 9999;
    box-shadow: 0 8px 24px rgba(0,0,0,.12);
  }
  .product-dropdown .pd-item {
    padding: 9px 14px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f5f5f5;
    font-size: 14px;
    transition: background .15s;
  }
  .product-dropdown .pd-item:hover { background: #f0f4ff; }
  .product-dropdown .pd-item .pd-price {
    font-weight: 700;
    color: #198754;
    font-size: 13px;
    white-space: nowrap;
    margin-left: 10px;
  }
  .product-dropdown .pd-cat {
    font-size: 10px;
    color: #aaa;
    padding: 5px 14px 3px;
    text-transform: uppercase;
    letter-spacing: .5px;
    font-weight: 700;
    background: #fafafa;
    position: sticky;
    top: 0;
  }
  /* ‚îÄ‚îÄ Customer search (expense) ‚îÄ‚îÄ */
  .cust-search-wrap { position: relative; }
  .cust-dropdown {
    display: none;
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: #fff;
    border: 1px solid #ffc107;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 220px;
    overflow-y: auto;
    z-index: 9999;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
  }
  .cust-dropdown .cd-item {
    padding: 9px 14px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    border-bottom: 1px solid #f5f5f5;
  }
  .cust-dropdown .cd-item:hover { background: #fffbea; }
  .selected-product-badge, .selected-cust-badge {
    display: none;
    background: #f0f4ff;
    border: 1px solid #0d6efd30;
    border-radius: 8px;
    padding: 7px 12px;
    margin-top: 6px;
    font-size: 13px;
    align-items: center;
    justify-content: space-between;
  }
  @media print {
    #navbar-placeholder, #footer-placeholder, .no-print { display: none !important; }
    .card { box-shadow: none !important; border: 1px solid #ddd !important; }
    body { font-size: 11px; }
    th { background: #1a5276 !important; color: #fff !important;
         -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>
</head>
<body data-page="mobil">
<div id="navbar-placeholder"></div>
<div class="container py-4">

  <h3 class="mb-4"><i class="bi bi-droplet-half me-2"></i>Mobil Oil Management</h3>

  <!-- 4 Stock Cards -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100" style="border-top:4px solid #0d6efd;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted mb-1" style="font-size:.78rem;">Car Mobil Stock</h6>
              <h2 class="mb-0 text-primary fw-bold" id="mobil-car-stock-page">0</h2>
              <small class="text-muted">Units Remaining</small>
            </div>
            <div style="background:rgba(13,110,253,.1);padding:.6rem;border-radius:8px;">
              <i class="bi bi-droplet-fill text-primary" style="font-size:1.6rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100" style="border-top:4px solid #198754;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted mb-1" style="font-size:.78rem;">Open Mobil Stock</h6>
              <h2 class="mb-0 text-success fw-bold" id="mobil-open-stock-page">0</h2>
              <small class="text-muted">Litres Remaining</small>
            </div>
            <div style="background:rgba(25,135,84,.1);padding:.6rem;border-radius:8px;">
              <i class="bi bi-droplet-fill text-success" style="font-size:1.6rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100" style="border-top:4px solid #fd7e14;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted mb-1" style="font-size:.78rem;">Car Mobil Sales</h6>
              <h2 class="mb-0 fw-bold" style="color:#fd7e14;" id="mobil-car-sales-page">0</h2>
              <small class="text-muted">Units Sold</small>
            </div>
            <div style="background:rgba(253,126,20,.1);padding:.6rem;border-radius:8px;">
              <i class="bi bi-cart-check-fill" style="font-size:1.6rem;color:#fd7e14;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100" style="border-top:4px solid #6f42c1;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="text-muted mb-1" style="font-size:.78rem;">Open Mobil Sales</h6>
              <h2 class="mb-0 fw-bold" style="color:#6f42c1;" id="mobil-open-sales-page">0</h2>
              <small class="text-muted">Litres Sold</small>
            </div>
            <div style="background:rgba(111,66,193,.1);padding:.6rem;border-radius:8px;">
              <i class="bi bi-cart-check-fill" style="font-size:1.6rem;color:#6f42c1;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-3 mb-4 no-print">
    <div class="col-6 col-md-3">
      <button class="btn btn-primary w-100 py-3" data-bs-toggle="modal" data-bs-target="#receiveMobilModal">
        <i class="bi bi-box-arrow-in-down me-2"></i>Receive Stock
      </button>
    </div>
    <div class="col-6 col-md-3">
      <button class="btn btn-success w-100 py-3" data-bs-toggle="modal" data-bs-target="#saleMobilModal">
        <i class="bi bi-cart-plus me-2"></i>Sale Entry
      </button>
    </div>
    <div class="col-6 col-md-3">
      <button class="btn btn-warning w-100 py-3" data-bs-toggle="modal" data-bs-target="#mobilExpenseModal">
        <i class="bi bi-wallet2 me-2"></i>Add Expense
      </button>
    </div>
    <div class="col-6 col-md-3">
      <button class="btn btn-info w-100 py-3 text-white" data-bs-toggle="modal" data-bs-target="#managePricesModal">
        <i class="bi bi-tags me-2"></i>Manage Prices
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Product Stock Overview ‚îÄ‚îÄ -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-box-seam me-2 text-primary"></i>Product-wise Stock</h6>
      <span class="badge bg-secondary" id="product-count">0 products</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Size</th>
              <th class="text-end">Current Price</th>
              <th class="text-end">Stock</th>
              <th class="text-end">Sold</th>
              <th class="no-print text-center">Action</th>
            </tr>
          </thead>
          <tbody id="product-stock-table">
            <tr><td colspan="7" class="text-center py-3 text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Transactions Card -->
  <div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-secondary"></i>Recent Mobil Transactions</h5>
      <div class="d-flex gap-2 no-print">
        <button class="btn btn-sm btn-outline-dark" onclick="printMobilTransactions()">
          <i class="bi bi-printer me-1"></i>Print
        </button>
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="no-print p-3 border-bottom" style="background:#f8f9fa;">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-sm-6 col-md-3">
          <label class="form-label small fw-bold mb-1"><i class="bi bi-search me-1"></i>Search</label>
          <input type="text" id="f-search" class="form-control form-control-sm"
            placeholder="Name, Product, Supplier..." oninput="applyMobilFilters()">
        </div>
        <div class="col-6 col-sm-3 col-md-2">
          <label class="form-label small fw-bold mb-1">Category</label>
          <select id="f-type" class="form-select form-select-sm" onchange="applyMobilFilters()">
            <option value="">All Types</option>
            <option value="Car Mobil">Car Mobil</option>
            <option value="Open Mobil">Open Mobil</option>
          </select>
        </div>
        <div class="col-6 col-sm-3 col-md-2">
          <label class="form-label small fw-bold mb-1">Transaction</label>
          <select id="f-kind" class="form-select form-select-sm" onchange="applyMobilFilters()">
            <option value="">All</option>
            <option value="arrival">Purchase</option>
            <option value="sale">Sale</option>
          </select>
        </div>
        <div class="col-6 col-sm-3 col-md-2">
          <label class="form-label small fw-bold mb-1">Period</label>
          <select id="f-period" class="form-select form-select-sm" onchange="applyMobilFilters()">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        <div class="col-3 col-sm-2 col-md-1">
          <label class="form-label small fw-bold mb-1">From</label>
          <input type="date" id="f-from" class="form-control form-control-sm" onchange="applyMobilFilters()">
        </div>
        <div class="col-3 col-sm-2 col-md-1">
          <label class="form-label small fw-bold mb-1">To</label>
          <input type="date" id="f-to" class="form-control form-control-sm" onchange="applyMobilFilters()">
        </div>
        <div class="col-6 col-sm-3 col-md-1">
          <button class="btn btn-sm btn-secondary w-100 mt-3" onclick="clearMobilFilters()">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>
      </div>
      <div class="mt-2">
        <small class="text-muted fw-bold" id="filter-result-info"></small>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="mobil-print-table">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Product</th>
              <th>Customer / Supplier</th>
              <th>Qty</th>
              <th>Rate</th>
              <th>Amount</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="mobil-transactions-table">
            <tr><td colspan="8" class="text-center text-muted py-4">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white no-print py-2" id="mobil-pagination-container"></div>
  </div>
</div>

<!-- =============================================================== -->
<!-- MODAL 1: RECEIVE STOCK                                          -->
<!-- =============================================================== -->
<div class="modal fade" id="receiveMobilModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<form id="receiveMobilForm" onsubmit="event.preventDefault(); receiveMobilStock();">
<div class="modal-header bg-primary text-white">
  <h5 class="modal-title"><i class="bi bi-box-arrow-in-down me-2"></i>Receive Mobil Stock</h5>
  <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">

  <!-- Product Search -->
  <div class="mb-3">
    <label class="form-label fw-bold">Product Select Karein *</label>
    <div class="product-search-wrap">
      <input type="hidden" id="receive-product-id">
      <input type="hidden" id="receive-category">
      <input type="text" id="receive-product-search" class="form-control"
        placeholder="üîç Product ka naam likhein..." autocomplete="off"
        oninput="searchProducts('receive')" onfocus="searchProducts('receive')">
      <div id="receive-product-dropdown" class="product-dropdown"></div>
    </div>
    <div id="receive-product-badge" class="selected-product-badge d-flex">
      <span id="receive-product-badge-text" class="fw-semibold text-primary"></span>
      <button type="button" class="btn-close btn-sm ms-auto"
        onclick="clearProductSelection('receive')"></button>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Supplier Name</label>
    <input id="receive-supplier" class="form-control" type="text" placeholder="e.g., PSO, Shell, GO Company">
  </div>
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label fw-bold">Quantity (Units/Litres) *</label>
      <input id="receive-quantity" class="form-control" type="number" step="0.01" min="0.01" required
        oninput="calcTotal('receive')">
    </div>
    <div class="col-md-6">
      <label class="form-label fw-bold">Purchase Rate *</label>
      <div class="input-group">
        <span class="input-group-text">Rs.</span>
        <input id="receive-rate" class="form-control" type="number" step="0.01" required
          oninput="calcTotal('receive')">
      </div>
    </div>
  </div>
  <div class="mb-3 mt-2">
    <label class="form-label">Total Cost</label>
    <div class="input-group">
      <span class="input-group-text">Rs.</span>
      <input id="receive-amount" class="form-control bg-light fw-bold" type="number" step="0.01" readonly>
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label fw-bold">Arrival Date *</label>
    <input id="receive-date" class="form-control" type="date" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Invoice / Bill Number</label>
    <input id="receive-invoice" class="form-control" type="text">
  </div>
  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea id="receive-notes" class="form-control" rows="2"></textarea>
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-primary" type="submit"><i class="bi bi-check-circle me-1"></i>Receive Stock</button>
</div>
</form>
</div></div></div>

<!-- =============================================================== -->
<!-- MODAL 2: SALE                                                   -->
<!-- =============================================================== -->
<div class="modal fade" id="saleMobilModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<form id="saleMobilForm" onsubmit="event.preventDefault(); saleMobilOil();">
<div class="modal-header bg-success text-white">
  <h5 class="modal-title"><i class="bi bi-cart-plus me-2"></i>Mobil Oil Sale</h5>
  <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">

  <!-- Customer Search ‚Äî same as transactions.html -->
  <div class="mb-3">
    <label class="form-label fw-bold">Customer *</label>
    <input type="hidden" id="sale-customer-hidden">
    <div style="position:relative;">
      <input type="text" id="sale-cust-search" class="form-control"
        placeholder="üîç Sr# ya naam likhein..." autocomplete="off">
      <div id="sale-cust-list"
        style="display:none;position:absolute;top:100%;left:0;right:0;z-index:9999;
          background:#fff;border:1px solid #198754;border-radius:6px;
          max-height:200px;overflow-y:auto;box-shadow:0 6px 20px rgba(0,0,0,.15);">
      </div>
    </div>
    <div id="sale-cust-selected"
      style="display:none;background:#f0fff4;border:1px solid #198754;border-radius:6px;
        padding:8px 12px;margin-top:4px;justify-content:space-between;align-items:center;">
      <span id="sale-cust-selected-text" style="font-weight:600;color:#198754;"></span>
      <span id="sale-cust-balance" style="font-size:12px;font-weight:700;margin-left:8px;"></span>
      <button type="button" onclick="window.clear_sd_sale()"
        style="background:none;border:none;color:#dc3545;font-size:16px;cursor:pointer;padding:0 4px;margin-left:auto;">‚úï</button>
    </div>
  </div>

  <!-- Product Search -->
  <div class="mb-3">
    <label class="form-label fw-bold">Product Select Karein *</label>
    <div class="product-search-wrap">
      <input type="hidden" id="sale-product-id">
      <input type="hidden" id="sale-category">
      <input type="text" id="sale-product-search" class="form-control"
        placeholder="üîç Product ka naam likhein..." autocomplete="off"
        oninput="searchProducts('sale')" onfocus="searchProducts('sale')">
      <div id="sale-product-dropdown" class="product-dropdown"></div>
    </div>
    <div id="sale-product-badge" class="selected-product-badge d-flex">
      <span id="sale-product-badge-text" class="fw-semibold text-success"></span>
      <button type="button" class="btn-close btn-sm ms-auto"
        onclick="clearProductSelection('sale')"></button>
    </div>
  </div>

  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label fw-bold">Quantity *</label>
      <input id="sale-quantity" class="form-control" type="number" step="0.01" min="0.01" required
        oninput="calcTotal('sale')">
    </div>
    <div class="col-md-6">
      <label class="form-label fw-bold">Sale Rate</label>
      <div class="input-group">
        <span class="input-group-text">Rs.</span>
        <input id="sale-rate" class="form-control" type="number" step="0.01"
          oninput="calcTotal('sale')" placeholder="Auto-fill hoga">
      </div>
    </div>
  </div>
  <div class="mb-3 mt-2">
    <label class="form-label">Total Amount</label>
    <div class="input-group">
      <span class="input-group-text">Rs.</span>
      <input id="sale-amount" class="form-control bg-light fw-bold" type="number" step="0.01" readonly>
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label fw-bold">Sale Date *</label>
    <input id="sale-date" class="form-control" type="date" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Payment Type</label>
    <select id="sale-payment-type" class="form-select">
      <option value="cash">Cash</option>
      <option value="credit">Credit (Udhaar)</option>
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea id="sale-notes" class="form-control" rows="2"></textarea>
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-success" type="submit"><i class="bi bi-check-circle me-1"></i>Complete Sale</button>
</div>
</form>
</div></div></div>

<!-- =============================================================== -->
<!-- =============================================================== -->
<!-- MODAL 3: EXPENSE ‚Äî Exact same as transactions page             -->
<!-- =============================================================== -->
<div class="modal fade" id="mobilExpenseModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<form id="mobilExpenseForm" onsubmit="event.preventDefault(); handleMobilExpense();">
<div class="modal-header bg-warning">
  <h5 class="modal-title"><i class="bi bi-wallet2 me-2"></i>Expense / Kharch</h5>
  <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">

  <!-- Customer (Optional) ‚Äî EXACT same HTML as transactions.html -->
  <div class="mb-3">
    <label class="form-label">Customer (Optional)
      <small class="text-muted fw-normal">‚Äî Agar kisi customer ki taraf se expense hai</small>
    </label>
    <input type="hidden" id="expense-customer-hidden">
    <div style="position:relative;">
      <input type="text" id="expense-cust-search" class="form-control"
        placeholder="üîç Sr# ya naam likhein... (blank chhodo = Owner account)"
        autocomplete="off">
      <div id="expense-cust-list"
        style="display:none;position:absolute;top:100%;left:0;right:0;z-index:9999;
          background:#fff;border:1px solid #e67e22;border-radius:6px;
          max-height:200px;overflow-y:auto;box-shadow:0 6px 20px rgba(0,0,0,.15);">
      </div>
    </div>
    <div id="expense-cust-selected"
      style="display:none;background:#fff8f0;border:1px solid #e67e22;border-radius:6px;
        padding:8px 12px;margin-top:4px;justify-content:space-between;align-items:center;">
      <span id="expense-cust-selected-text" style="font-weight:600;color:#e67e22;"></span>
      <span id="expense-cust-balance" style="font-size:12px;font-weight:700;margin-left:8px;"></span>
      <button type="button" onclick="window.clear_sd_expense()"
        style="background:none;border:none;color:#dc3545;font-size:16px;cursor:pointer;padding:0 4px;margin-left:auto;">‚úï</button>
    </div>
  </div>

  <!-- Expense Type from DB (same as transactions) -->
  <div class="mb-3">
    <label class="form-label">Expense Type *</label>
    <select class="form-select" id="expense-type" required>
      <option value="">-- Loading categories... --</option>
    </select>
  </div>

  <!-- Pay From Account -->
  <div class="mb-3">
    <label class="form-label">Pay From Account *</label>
    <select class="form-select" id="expense-account" required>
      <option value="">Select Account</option>
      <option value="Owner">Owner Account</option>
      <option value="Cash">Cash</option>
      <option value="Bank">Bank</option>
    </select>
  </div>

  <!-- Amount -->
  <div class="mb-3">
    <label class="form-label">Amount *</label>
    <div class="input-group">
      <span class="input-group-text">Rs.</span>
      <input class="form-control" id="expense-amount" required step="0.01" type="number" placeholder="0.00"/>
    </div>
  </div>

  <!-- Description -->
  <div class="mb-3">
    <label class="form-label">Description *</label>
    <input class="form-control" id="expense-description" required type="text"
      placeholder="Expense ki tafseel likhein..."/>
  </div>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
  <button class="btn btn-warning fw-bold" type="submit">
    <i class="bi bi-check-circle me-1"></i>Save Expense
  </button>
</div>
</form>
</div></div></div>

<!-- =============================================================== -->
<!-- MODAL 4: MANAGE PRICES                                          -->
<!-- =============================================================== -->
<div class="modal fade" id="managePricesModal" tabindex="-1">
<div class="modal-dialog modal-lg"><div class="modal-content">
<div class="modal-header bg-info text-white">
  <h5 class="modal-title"><i class="bi bi-tags me-2"></i>Product Prices Manage Karein</h5>
  <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
  <div class="alert alert-info py-2 mb-3" style="font-size:13px;">
    <i class="bi bi-info-circle me-1"></i>
    Kisi product ki price update karo ‚Äî pehli wali price history mein save rahegi.
  </div>

  <!-- Price Update Form -->
  <div class="card border-warning mb-3">
    <div class="card-header bg-warning py-2"><strong>üí∞ Naya Price Set Karein</strong></div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-5">
          <label class="form-label fw-bold">Product *</label>
          <select id="price-product-select" class="form-select" onchange="onPriceProductChange()">
            <option value="">-- Product Select Karein --</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Naya Sale Price *</label>
          <div class="input-group">
            <span class="input-group-text">Rs.</span>
            <input id="price-new-sale" class="form-control" type="number" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold">Date *</label>
          <input id="price-effective-date" class="form-control" type="date">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-warning w-100" onclick="savePriceUpdate()">
            <i class="bi bi-check-circle me-1"></i>Save
          </button>
        </div>
      </div>
      <div class="mt-2">
        <input id="price-notes" class="form-control form-control-sm"
          placeholder="Note (optional): e.g. Price increase Feb 2026">
      </div>
      <div id="price-current-info" class="mt-2 text-muted small"></div>
    </div>
  </div>

  <!-- Product Price List -->
  <div class="table-responsive">
    <table class="table table-sm table-hover">
      <thead class="table-info">
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Size</th>
          <th class="text-end">Current Price</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody id="manage-prices-table">
        <tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Add New Product -->
  <hr>
  <details>
    <summary class="fw-bold text-primary" style="cursor:pointer; font-size:14px;">
      <i class="bi bi-plus-circle me-1"></i> Naya Product Add Karein
    </summary>
    <div class="card mt-2 border-primary">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label fw-bold">Product Name *</label>
            <input id="new-prod-name" class="form-control" placeholder="e.g. Go Performa">
          </div>
          <div class="col-md-2">
            <label class="form-label">Brand</label>
            <input id="new-prod-brand" class="form-control" placeholder="GO" value="GO">
          </div>
          <div class="col-md-2">
            <label class="form-label">Grade</label>
            <input id="new-prod-grade" class="form-control" placeholder="20w-50">
          </div>
          <div class="col-md-2">
            <label class="form-label">Volume (ml)</label>
            <input id="new-prod-volume" class="form-control" type="number" placeholder="4000">
          </div>
          <div class="col-md-2">
            <label class="form-label fw-bold">Category *</label>
            <select id="new-prod-category" class="form-select">
              <option value="Car Mobil">Car Mobil</option>
              <option value="Open Mobil">Open Mobil</option>
            </select>
          </div>
        </div>
        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label fw-bold">Starting Price *</label>
            <div class="input-group">
              <span class="input-group-text">Rs.</span>
              <input id="new-prod-price" class="form-control" type="number" step="0.01" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="saveNewProduct()">
              <i class="bi bi-plus me-1"></i>Add
            </button>
          </div>
        </div>
      </div>
    </div>
  </details>
</div>
<div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
</div></div></div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:9999">
  <div id="liveToast" class="toast" role="alert">
    <div class="toast-header">
      <strong class="me-auto" id="toast-title">Info</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body" id="toast-message">...</div>
  </div>
</div>

<div id="footer-placeholder"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script src="js/app.js"></script>

<script>
/* ================================================================
   MOBIL PAGE ‚Äî Product search + Customer search (exact same as
   transactions-COMPLETE-v5.js) + Price management
================================================================ */
const supabase = window.supabaseClient;

let allProducts      = [];
let allCustomers     = [];
let expenseCategories= [];
// Same structure as transactions-COMPLETE-v5.js
let selectedCustomers = { sale: null, vasooli: null, advance: null, expense: null };
let today = new Date().toISOString().slice(0,10);

function el(id){ return document.getElementById(id); }
function fmt(n){ return Number(n||0).toLocaleString('en-PK',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function formatVolume(ml){ return ml>=1000?(ml/1000)+'L':ml+'ml'; }

function showToast(type, title, msg) {
  const t = el('liveToast');
  if(!t){ alert(title+': '+msg); return; }
  el('toast-title').textContent   = title;
  el('toast-message').textContent = msg;
  t.className='toast '+(type==='success'?'bg-success text-white':type==='error'?'bg-danger text-white':'bg-warning text-dark');
  new bootstrap.Toast(t,{delay:3500}).show();
}

function closeModal(id){
  const m=el(id);
  if(m){ const i=bootstrap.Modal.getInstance(m); if(i) i.hide(); }
  const f=document.querySelector('#'+id+' form');
  if(f) f.reset();
}

document.addEventListener('DOMContentLoaded', async () => {
  // Date inputs today set karo
  ['receive-date','sale-date','price-effective-date']
    .forEach(id => { const e=el(id); if(e) e.value=today; });

  await loadCustomers();          // customers pehle load karo
  await loadExpenseCategories();  // expense categories
  initAllMobilDropdowns();        // sale + expense customer dropdowns
  await loadProducts();           // mobil products
  renderProductStockTable();
  renderManagePricesTable();

  if(typeof loadMobilData === 'function') loadMobilData();
});

/* ================================================================
   LOAD CUSTOMERS ‚Äî same as transactions.js
================================================================ */
async function loadCustomers(){
  const {data,error} = await supabase
    .from('customers')
    .select('id, sr_no, name, phone, category, balance')
    .order('sr_no');
  if(!error && data) allCustomers = data;
}

/* ================================================================
   EXPENSE CATEGORIES ‚Äî exact copy from transactions-COMPLETE-v5.js
================================================================ */
async function loadExpenseCategories(){
  try{
    const {data} = await supabase.from('expense_categories').select('*').order('name');
    expenseCategories = (data && data.length) ? data : [
      {name:'Bijli Bill',icon:'‚ö°'},{name:'Gas Bill',icon:'üî•'},
      {name:'Paani Bill',icon:'üíß'},{name:'Kiraaya',icon:'üè†'},
      {name:'Petrol/Diesel Stock',icon:'‚õΩ'},{name:'Mazdoor Tankhwah',icon:'üë∑'},
      {name:'Machine Repair',icon:'üîß'},{name:'Khaana/Chai',icon:'‚òï'},
      {name:'Transport',icon:'üöõ'},{name:'Stationery',icon:'üìã'},
      {name:'Bank Charges',icon:'üè¶'},{name:'Mobile/Internet',icon:'üì±'},
      {name:'Miscellaneous',icon:'üì¶'}
    ];
    const expEl = el('expense-type');
    if(expEl) expEl.innerHTML =
      '<option value="">-- Category Select Karein --</option>'+
      expenseCategories.map(c=>`<option value="${c.name}">${c.icon||''} ${c.name}</option>`).join('');
  }catch(e){ console.error('loadExpenseCategories:',e); }
}

/* ================================================================
   ALL CUSTOMER DROPDOWNS ‚Äî same buildSearchDropdown as transactions-v5
   Keys: 'sale' (green), 'expense' (orange)
================================================================ */
function initAllMobilDropdowns(){
  const configs = [
    {
      key:'sale',    color:'#198754', modalId:'saleMobilModal',
      searchId:'sale-cust-search',   listId:'sale-cust-list',
      hiddenId:'sale-customer-hidden', selectedBoxId:'sale-cust-selected',
      selectedTextId:'sale-cust-selected-text', selectedBalId:'sale-cust-balance',
      custFilter: ()=>true
    },
    {
      key:'expense', color:'#e67e22', modalId:'mobilExpenseModal',
      searchId:'expense-cust-search', listId:'expense-cust-list',
      hiddenId:'expense-customer-hidden', selectedBoxId:'expense-cust-selected',
      selectedTextId:'expense-cust-selected-text', selectedBalId:'expense-cust-balance',
      custFilter: c=>c.category!=='Owner'
    }
  ];

  configs.forEach(opts => {
    const searchEl = el(opts.searchId);
    const listEl   = el(opts.listId);
    const hiddenEl = el(opts.hiddenId);
    const boxEl    = el(opts.selectedBoxId);
    const textEl   = el(opts.selectedTextId);
    const balEl    = el(opts.selectedBalId);
    const color    = opts.color;
    if(!searchEl || !listEl) return;

    searchEl.style.border = `2px solid ${color}`;
    const customers = allCustomers.filter(opts.custFilter);

    function renderList(q){
      const filtered = q
        ? customers.filter(c =>
            c.name.toLowerCase().includes(q.toLowerCase()) ||
            String(c.sr_no||'').includes(q))
        : customers;

      if(!filtered.length){
        listEl.innerHTML=`<div style="padding:12px;color:#888;text-align:center;font-size:13px;">Koi nahi mila</div>`;
        listEl.style.display='block'; return;
      }

      listEl.innerHTML = filtered.map(c => {
        const bal = parseFloat(c.balance)||0;
        return `<div class="sd-item-${opts.key}" data-id="${c.id}"
          style="padding:10px 14px;cursor:pointer;display:flex;justify-content:space-between;
                 align-items:center;border-bottom:1px solid #f5f5f5;font-size:14px;">
          <span>
            <span style="background:${color};color:#fff;border-radius:4px;
              padding:1px 7px;font-size:11px;font-weight:700;margin-right:8px;">#${c.sr_no||'-'}</span>
            ${c.name}
          </span>
          <span style="font-size:12px;font-weight:700;color:${bal>0?'#dc3545':'#198754'};">
            Rs.${fmt(bal)}
          </span>
        </div>`;
      }).join('');

      listEl.style.display = 'block';

      listEl.querySelectorAll(`.sd-item-${opts.key}`).forEach(item => {
        item.addEventListener('mouseenter', ()=> item.style.background='#f8f9ff');
        item.addEventListener('mouseleave', ()=> item.style.background='');
        item.addEventListener('mousedown', e => {
          e.preventDefault();
          const cust = customers.find(c => c.id == item.dataset.id);
          if(!cust) return;
          selectedCustomers[opts.key] = cust;
          if(hiddenEl) hiddenEl.value = cust.id;
          searchEl.value = '';
          listEl.style.display = 'none';
          if(textEl) textEl.textContent = `#${cust.sr_no||'-'} ‚Äî ${cust.name}`;
          if(balEl){
            const b = parseFloat(cust.balance)||0;
            balEl.textContent = b>0 ? `‚ö†Ô∏è Khata Baqi: Rs.${fmt(b)}` : `‚úÖ Account Saaf`;
            balEl.style.color = b>0 ? '#dc3545' : '#198754';
          }
          if(boxEl) boxEl.style.display = 'flex';
          searchEl.style.display = 'none';
        });
      });
    }

    searchEl.addEventListener('input',  ()=> renderList(searchEl.value));
    searchEl.addEventListener('focus',  ()=> renderList(searchEl.value));
    searchEl.addEventListener('blur',   ()=> setTimeout(()=>{ listEl.style.display='none'; }, 200));

    window['clear_sd_'+opts.key] = function(){
      selectedCustomers[opts.key] = null;
      if(hiddenEl) hiddenEl.value = '';
      searchEl.value=''; searchEl.style.display='block';
      if(boxEl) boxEl.style.display='none';
      listEl.style.display='none';
      searchEl.focus();
    };

    const modalEl = el(opts.modalId);
    if(modalEl){
      modalEl.addEventListener('show.bs.modal', ()=>{
        selectedCustomers[opts.key] = null;
        if(hiddenEl) hiddenEl.value='';
        searchEl.value=''; searchEl.style.display='block';
        if(boxEl) boxEl.style.display='none';
        listEl.style.display='none';
      });
    }
  });

  // Expense form submit
  el('mobilExpenseForm')?.addEventListener('submit', e=>{ e.preventDefault(); handleMobilExpense(); });
}

/* ================================================================
   HANDLE EXPENSE ‚Äî EXACT same logic as handleExpense() in
   transactions-COMPLETE-v5.js
================================================================ */
async function handleMobilExpense(){
  const amount      = parseFloat(el('expense-amount')?.value)||0;
  const description = el('expense-description')?.value||'';
  const expType     = el('expense-type')?.value;
  const account     = el('expense-account')?.value;
  const cust        = selectedCustomers.expense;  // optional

  if(!amount)     { alert('Amount enter karein'); return; }
  if(!description){ alert('Description enter karein'); return; }
  if(!expType)    { alert('Category select karein'); return; }
  if(!account)    { alert('Account select karein'); return; }

  try{
    let custId = null;
    if(cust){
      // Customer selected ‚Äî usi ke account pe charge lagao
      custId = parseInt(cust.id);
    } else {
      // Owner account ‚Äî transactions.js se same logic
      const {data:owner} = await supabase.from('customers')
        .select('id').eq('category','Owner').maybeSingle();
      if(owner){ custId = owner.id; }
      else{
        const {data:no, error:ce} = await supabase.from('customers')
          .insert([{sr_no:0, name:'Owner', category:'Owner', balance:0}])
          .select().single();
        if(ce) throw ce;
        custId = no.id;
      }
    }

    // transactions table mein insert ‚Äî same columns as transactions.js
    const {error} = await supabase.from('transactions').insert([{
      customer_id:      custId,
      transaction_type: 'Expense',
      amount,
      description:      `${expType}: ${description} (From: ${account})`
    }]);
    if(error) throw error;

    showToast('success','Kamyab!','Expense record ho gaya!');
    closeModal('mobilExpenseModal');
    selectedCustomers.expense = null;

    // Customer list refresh
    await loadCustomers();
    initAllMobilDropdowns();
    if(typeof loadMobilData === 'function') loadMobilData();

  }catch(e){ alert('Expense Error: '+e.message); }
}

/* ================================================================
   LOAD PRODUCTS
================================================================ */
async function loadProducts(){
  const {data,error} = await supabase
    .from('v_mobil_products_current')
    .select('*')
    .order('sort_order');
  if(!error && data){
    allProducts = data;
    const cnt = el('product-count'); if(cnt) cnt.textContent = data.length+' products';
    const sel = el('price-product-select');
    if(sel){
      sel.innerHTML = '<option value="">-- Product Select Karein --</option>' +
        data.map(p=>`<option value="${p.id}" data-price="${p.current_sale_price||0}">
          ${p.name}${p.volume_ml?' ('+formatVolume(p.volume_ml)+')':''}${p.grade?' '+p.grade:''} ‚Äî Rs.${fmt(p.current_sale_price)}</option>`).join('');
    }
  }
}

/* ================================================================
   PRODUCT SEARCH DROPDOWN
================================================================ */
function searchProducts(prefix) {
  const q = (el(prefix+'-product-search')?.value||'').toLowerCase();
  const dd = el(prefix+'-product-dropdown');
  if(!dd) return;

  const filtered = q
    ? allProducts.filter(p =>
        p.name.toLowerCase().includes(q) ||
        (p.grade||'').toLowerCase().includes(q) ||
        (p.category||'').toLowerCase().includes(q))
    : allProducts;

  if(!filtered.length){ dd.style.display='none'; return; }

  // Group by category
  const groups = {};
  filtered.forEach(p => {
    if(!groups[p.category]) groups[p.category]=[];
    groups[p.category].push(p);
  });

  let html = '';
  Object.keys(groups).forEach(cat => {
    html += `<div class="pd-cat">${cat}</div>`;
    groups[cat].forEach(p => {
      const label = p.name+(p.volume_ml?' '+formatVolume(p.volume_ml):'')+(p.grade?' ('+p.grade+')':'');
      html += `<div class="pd-item" onmousedown="selectProduct('${prefix}',${p.id},'${label.replace(/'/g,"\\'")}','${p.category}',${p.current_sale_price||0})">
        <span>${label}</span>
        <span class="pd-price">Rs.${fmt(p.current_sale_price)}</span>
      </div>`;
    });
  });

  dd.innerHTML = html;
  dd.style.display = 'block';
}

function selectProduct(prefix, id, label, category, price) {
  el(prefix+'-product-id').value     = id;
  el(prefix+'-category').value       = category;
  el(prefix+'-product-search').value = label;
  el(prefix+'-product-dropdown').style.display = 'none';

  const badge     = el(prefix+'-product-badge');
  const badgeText = el(prefix+'-product-badge-text');
  if(badge && badgeText){
    badgeText.textContent = label+' ‚Äî Rs.'+fmt(price);
    badge.style.display   = 'flex';
  }
  const rateField = el(prefix+'-rate');
  if(rateField && !rateField.value) rateField.value = price;
  calcTotal(prefix);
}

function clearProductSelection(prefix) {
  el(prefix+'-product-id').value     = '';
  el(prefix+'-category').value       = '';
  el(prefix+'-product-search').value = '';
  const badge = el(prefix+'-product-badge');
  if(badge) badge.style.display = 'none';
  const rateField = el(prefix+'-rate');
  if(rateField) rateField.value = '';
  calcTotal(prefix);
}

document.addEventListener('click', e => {
  document.querySelectorAll('.product-dropdown').forEach(dd => {
    if(!dd.closest('.product-search-wrap')?.contains(e.target)) dd.style.display='none';
  });
});

/* ================================================================
   CALC TOTAL
================================================================ */
function calcTotal(prefix) {
  const qty  = parseFloat(el(prefix+'-quantity')?.value)||0;
  const rate = parseFloat(el(prefix+'-rate')?.value)||0;
  const amtEl = el(prefix+'-amount');
  if(amtEl) amtEl.value = (qty*rate).toFixed(2);
}

/* ================================================================
   RECEIVE STOCK SAVE
================================================================ */
async function receiveMobilStock() {
  const productId = el('receive-product-id')?.value;
  const category  = el('receive-category')?.value;
  const prodName  = el('receive-product-search')?.value;
  const supplier  = el('receive-supplier')?.value||'';
  const qty       = parseFloat(el('receive-quantity')?.value)||0;
  const rate      = parseFloat(el('receive-rate')?.value)||0;
  const total     = parseFloat(el('receive-amount')?.value)||0;
  const date      = el('receive-date')?.value;
  const invoice   = el('receive-invoice')?.value||'';
  const notes     = el('receive-notes')?.value||'';

  if(!productId){ alert('Product select karein'); return; }
  if(!qty)      { alert('Quantity enter karein'); return; }
  if(!rate)     { alert('Rate enter karein'); return; }

  const {error} = await supabase.from('mobil_arrivals').insert([{
    product_id:   parseInt(productId),
    product_name: prodName,
    category,
    supplier,
    quantity:     qty,
    rate,
    total_cost:   total,
    arrival_date: date,
    invoice_no:   invoice,
    notes
  }]);

  if(error){ showToast('error','Error',error.message); return; }
  showToast('success','Done!',`${prodName} ‚Äî ${qty} units received!`);
  bootstrap.Modal.getInstance(el('receiveMobilModal'))?.hide();
  el('receiveMobilForm').reset();
  clearProductSelection('receive');
  renderProductStockTable();
  if(typeof loadMobilData === 'function') loadMobilData();
}

/* ================================================================
   SALE SAVE ‚Äî same pattern as transactions-COMPLETE-v5.js
================================================================ */
async function saleMobilOil() {
  const cust      = selectedCustomers.sale;  // from dropdown
  const productId = el('sale-product-id')?.value;
  const category  = el('sale-category')?.value;
  const prodName  = el('sale-product-search')?.value;
  const qty       = parseFloat(el('sale-quantity')?.value)||0;
  const rate      = parseFloat(el('sale-rate')?.value)||0;
  const total     = parseFloat(el('sale-amount')?.value)||0;
  const date      = el('sale-date')?.value;
  const payType   = el('sale-payment-type')?.value||'cash';
  const notes     = el('sale-notes')?.value||'';

  if(!productId){ alert('Product select karein'); return; }
  if(!qty)      { alert('Quantity enter karein'); return; }

  const {error} = await supabase.from('mobil_sales').insert([{
    customer_id:   cust ? parseInt(cust.id) : null,
    customer_name: cust ? `#${cust.sr_no||'-'} ‚Äî ${cust.name}` : 'Walk-in',
    product_id:    parseInt(productId),
    product_name:  prodName,
    category,
    quantity:      qty,
    rate,
    total_amount:  total,
    payment_type:  payType,
    sale_date:     date,
    notes
  }]);

  if(error){ showToast('error','Error',error.message); return; }
  showToast('success','Sale Done!',`${prodName} ‚Äî Rs.${fmt(total)} sale!`);
  bootstrap.Modal.getInstance(el('saleMobilModal'))?.hide();
  el('saleMobilForm')?.reset();
  clearProductSelection('sale');
  selectedCustomers.sale = null;
  renderProductStockTable();
  if(typeof loadMobilData === 'function') loadMobilData();
}


/* ================================================================
   PRODUCT STOCK TABLE
================================================================ */
async function renderProductStockTable() {
  const tbody = el('product-stock-table');
  if(!tbody) return;
  const {data,error} = await supabase.from('v_mobil_stock_balance').select('*');
  if(error||!data){ tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Error loading</td></tr>'; return; }

  const priceMap = {};
  allProducts.forEach(p => priceMap[p.id] = p.current_sale_price);

  tbody.innerHTML = data.map(row => {
    const bal = parseFloat(row.stock_balance);
    const price = priceMap[row.product_id]||0;
    const catColor = row.category==='Car Mobil'?'#0d6efd':'#198754';
    return `<tr>
      <td><strong>${row.product_name}</strong></td>
      <td><span style="background:${catColor}20;color:${catColor};padding:2px 8px;border-radius:4px;font-size:12px;">${row.category}</span></td>
      <td>${row.volume_ml?formatVolume(row.volume_ml):'‚Äî'}</td>
      <td class="text-end fw-bold text-success">Rs.${fmt(price)}</td>
      <td class="text-end fw-bold" style="color:${bal>0?'#198754':'#dc3545'};">${bal}</td>
      <td class="text-end text-muted">${row.total_sold}</td>
      <td class="text-center no-print">
        <button class="btn btn-xs btn-outline-warning" style="font-size:11px;padding:2px 8px;"
          onclick="quickPriceUpdate(${row.product_id},'${row.product_name.replace(/'/g,"\\'")}',${price})">
          <i class="bi bi-tag"></i> Price
        </button>
      </td>
    </tr>`;
  }).join('')||'<tr><td colspan="7" class="text-center text-muted py-3">Koi product nahi</td></tr>';
}

/* ================================================================
   MANAGE PRICES TABLE
================================================================ */
function renderManagePricesTable(){
  const tbody = el('manage-prices-table');
  if(!tbody||!allProducts.length) return;
  tbody.innerHTML = allProducts.map(p=>`<tr>
    <td><strong>${p.name}</strong></td>
    <td><small>${p.category}</small></td>
    <td>${p.volume_ml?formatVolume(p.volume_ml):'‚Äî'}</td>
    <td class="text-end fw-bold text-success">Rs.${fmt(p.current_sale_price)}</td>
    <td class="text-center">
      <button class="btn btn-sm btn-outline-warning"
        onclick="quickPriceUpdate(${p.id},'${p.name.replace(/'/g,"\\'")}',${p.current_sale_price||0})">
        <i class="bi bi-pencil me-1"></i>Update
      </button>
    </td>
  </tr>`).join('');
}

function onPriceProductChange(){
  const sel = el('price-product-select');
  const opt = sel?.options[sel.selectedIndex];
  const info = el('price-current-info');
  if(opt?.value && info){
    info.innerHTML=`Mojuda price: <strong class="text-success">Rs.${fmt(parseFloat(opt.dataset.price)||0)}</strong>`;
    el('price-new-sale')?.focus();
  }
}

function quickPriceUpdate(productId, productName, currentPrice){
  const sel = el('price-product-select');
  if(sel) sel.value = productId;
  onPriceProductChange();
  const pns = el('price-new-sale'); if(pns) pns.value = currentPrice;
  new bootstrap.Modal(el('managePricesModal')).show();
}

async function savePriceUpdate(){
  const productId = el('price-product-select')?.value;
  const newPrice  = parseFloat(el('price-new-sale')?.value)||0;
  const effDate   = el('price-effective-date')?.value||today;
  const notes     = el('price-notes')?.value||'';

  if(!productId){ alert('Product select karein'); return; }
  if(!newPrice) { alert('Naya price enter karein'); return; }

  const {error} = await supabase.from('mobil_product_prices').insert([{
    product_id:parseInt(productId), sale_price:newPrice, effective_date:effDate, notes
  }]);
  if(error){ showToast('error','Error',error.message); return; }
  showToast('success','Price Updated!',`New price Rs.${fmt(newPrice)} set ho gaya!`);
  await loadProducts();
  renderProductStockTable();
  renderManagePricesTable();
  const pns=el('price-new-sale'); if(pns) pns.value='';
  const pno=el('price-notes'); if(pno) pno.value='';
}

async function saveNewProduct(){
  const name     = el('new-prod-name')?.value?.trim();
  const brand    = el('new-prod-brand')?.value?.trim()||'GO';
  const grade    = el('new-prod-grade')?.value?.trim()||null;
  const volume   = parseInt(el('new-prod-volume')?.value)||null;
  const category = el('new-prod-category')?.value||'Car Mobil';
  const price    = parseFloat(el('new-prod-price')?.value)||0;

  if(!name) { alert('Product naam likhein'); return; }
  if(!price){ alert('Starting price enter karein'); return; }

  const {data:prod, error:pe} = await supabase.from('mobil_products')
    .insert([{name, brand, grade, volume_ml:volume, category, sort_order:allProducts.length+1}])
    .select().single();
  if(pe){ showToast('error','Error',pe.message); return; }

  await supabase.from('mobil_product_prices').insert([{
    product_id:prod.id, sale_price:price, effective_date:today, notes:'Initial price'
  }]);

  showToast('success','Product Added!',`${name} add ho gaya!`);
  await loadProducts();
  renderProductStockTable();
  renderManagePricesTable();
  ['new-prod-name','new-prod-grade','new-prod-volume','new-prod-price']
    .forEach(id=>{ const e=el(id); if(e) e.value=''; });
}

// Placeholders ‚Äî mobil-management.js provide karega
function applyMobilFilters(){}
function clearMobilFilters(){}
function printMobilTransactions(){}
</script>

<script src="js/mobil-management.js?v=5"></script>
</body>
</html>