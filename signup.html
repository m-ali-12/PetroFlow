<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up | Petrol Pump Management</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }

    .auth-container {
      max-width: 550px;
      width: 100%;
      padding: 20px;
    }

    .auth-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 40px;
    }

    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-section h3 {
      color: #333;
      font-weight: 700;
    }

    .form-control, .form-select {
      border-radius: 10px;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
    }

    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-auth {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      color: white;
      width: 100%;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f0f0;
    }

    .link-text {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="auth-container">
    <div class="auth-card">
      <div class="logo-section">
        <h3>Create Account</h3>
        <p class="text-muted">Setup your petrol pump management</p>
      </div>

      <div id="alert-container"></div>

      <form id="signupForm">
        <!-- Account Details -->
        <div class="section-title">
          <i class="bi bi-person-circle me-2"></i>Account Details
        </div>

        <div class="mb-3">
          <label class="form-label">Full Name *</label>
          <input type="text" class="form-control" id="fullName" required>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label">Email *</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-control" id="phone" placeholder="03XX-XXXXXXX">
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label">Password * (min 6 chars)</label>
            <input type="password" class="form-control" id="password" minlength="6" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Confirm Password *</label>
            <input type="password" class="form-control" id="confirmPassword" required>
          </div>
        </div>

        <!-- Pump Details -->
        <div class="section-title mt-4">
          <i class="bi bi-shop me-2"></i>Pump Details
        </div>

        <div class="mb-3">
          <label class="form-label">Pump Name *</label>
          <input type="text" class="form-control" id="pumpName" placeholder="e.g., Khalid & Sons Petroleum" required>
          <small class="text-muted">This will appear on all reports</small>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label">City *</label>
            <input type="text" class="form-control" id="city" placeholder="e.g., Sahiwal" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Province *</label>
            <select class="form-select" id="province" required>
              <option value="">Select Province</option>
              <option value="Punjab">Punjab</option>
              <option value="Sindh">Sindh</option>
              <option value="KPK">KPK</option>
              <option value="Balochistan">Balochistan</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Address</label>
          <textarea class="form-control" id="address" rows="2" placeholder="Full address"></textarea>
        </div>

        <button type="submit" class="btn btn-auth" id="signupBtn">
          <i class="bi bi-check-circle me-2"></i>Create Account
        </button>
      </form>

      <hr class="my-4">

      <div class="text-center">
        <p class="mb-0">Already have an account? <a href="login.html" class="link-text">Sign In</a></p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>

  <script>
    // Initialize Supabase
    const supabase = window.supabaseClient;

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (password !== confirmPassword) {
        showAlert('Passwords do not match!', 'danger');
        return;
      }

      if (password.length < 6) {
        showAlert('Password must be at least 6 characters!', 'danger');
        return;
      }

      const btn = document.getElementById('signupBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';

      try {
        const email = document.getElementById('email').value;
        const fullName = document.getElementById('fullName').value;
        const phone = document.getElementById('phone').value;
        const pumpName = document.getElementById('pumpName').value;
        const city = document.getElementById('city').value;
        const province = document.getElementById('province').value;
        const address = document.getElementById('address').value;

        console.log('Starting signup for:', email);

        // Create user account with metadata
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              full_name: fullName,
              phone: phone,
              pump_name: pumpName,
              city: city,
              province: province,
              address: address
            },
            emailRedirectTo: 'https://petro-flow.vercel.app/login.html'  // â† NEW (your actual domain)

            // window.location.origin + '/login.html'
          }
        });

        if (authError) {
          console.error('Auth error:', authError);
          throw authError;
        }

        console.log('Signup successful:', authData);

        // Store pump details in localStorage as backup
        localStorage.setItem('pump_details', JSON.stringify({
          name: pumpName,
          city: city,
          province: province,
          address: address,
          owner: fullName,
          phone: phone
        }));

        showAlert('Account created successfully! Please check your email to verify.', 'success');
        
        // Redirect after 3 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);

      } catch (error) {
        console.error('Signup error details:', error);
        
        let errorMessage = error.message;
        
        // Handle specific errors
        if (error.message?.includes('User already registered')) {
          errorMessage = 'This email is already registered. Please login instead.';
        } else if (error.message?.includes('Invalid email')) {
          errorMessage = 'Please enter a valid email address.';
        } else if (error.message?.includes('Password')) {
          errorMessage = 'Password must be at least 6 characters long.';
        } else if (error.status === 500) {
          errorMessage = 'Server error. Please check your Supabase configuration.';
        }
        
        showAlert(errorMessage, 'danger');
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Create Account';
      }
    });

    function showAlert(message, type) {
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      document.getElementById('alert-container').innerHTML = alertHtml;
      
      // Scroll to top to show alert
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Check if already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) {
        console.log('User already logged in, redirecting...');
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>